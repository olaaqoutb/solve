<!-- freigabe-korrigieren.component.html -->
<div class="container">
  <div class="header">
    <button
        [matMenuTriggerFor]="menu"
        class="custom-menu menu-icon-right-top"
      >
        <mat-icon>menu</mat-icon>
      </button>

    <div class="header-main">

      <mat-menu #menu="matMenu">
        <!-- Call openLogbuch when this menu item is clicked -->
        <button mat-menu-item id="option-menu" (click)="openLogbuch()">
          <mat-icon>article</mat-icon>Logbuch
        </button>
      </mat-menu>

      <span class="title">Freigabe</span>
    <mat-form-field appearance="outline" class="dropdown">
  <mat-select [(value)]="selectedOption" id="drop" (selectionChange)="onDropdownChange()">
    <mat-option *ngFor="let option of dropdownOptions" [value]="option">
      {{ option }}
    </mat-option>
  </mat-select>
</mat-form-field>
    </div>

    <!-- Logbuch Overlay -->
  <div class="logbuch-overlay" *ngIf="showLogbuch">
  <div class="logbuch-dialog">
    <div class="logbuch-header">
      <div class="arrows">
        <button
          mat-icon-button
          (click)="navigateLogbuch('prev')"
          [disabled]="currentLogbuchEntryIndex === 0"
        >
          <mat-icon class="menu-arrows">keyboard_arrow_left</mat-icon>
        </button>
        <button
          mat-icon-button
          (click)="navigateLogbuch('next')"
          [disabled]="currentLogbuchEntryIndex >= logbuchEntries.length - 1"
        >
          <mat-icon class="menu-arrows">keyboard_arrow_right</mat-icon>
        </button>
      </div>
      <div class="navigation-arrows">
        <span class="logbuch-title">Logbuch</span>
      </div>
    </div>

    <div class="logbuch-content" *ngIf="selectedLogbuchEntry">
      <!-- First Format: Simple display without vorher/nachher -->
      <div *ngIf="shouldShowSimpleFormat()" class="simple-format">
        <div class="logbuch-section logbuch-section1">
          <p>
            <strong class="field-group-mid">Geändert am</strong>
            {{ selectedLogbuchEntry["Bearbeitungszeit"] }}
          </p>
          <p id="geander-von">
            <strong class="field-group-mid">Geändert von</strong>
            {{ selectedLogbuchEntry["Bearbeiter"] }} ({{
              selectedLogbuchEntry["Bearbeiter Id"]
            }})
          </p>
          <p><strong class="erstversion">Erstversion</strong></p>

          <p>
            <strong class="field-group-mid">Minutendauer</strong>
            {{ selectedLogbuchEntry["Minutendauer"] }} Minuten
          </p>

          <p>
            <strong class="field-group-mid mid2">Freigabestatus</strong>
            {{ selectedLogbuchEntry["Freigabestatus"] }}
          </p>
          <p>
            <strong class="field-group-lg">Buchungszeitraum</strong>
            {{ selectedLogbuchEntry["Buchungszeitraum"] }}
          </p>

          <p>
            <strong class="field-group-sm">Bucher</strong>
            {{ selectedLogbuchEntry["Bucher"] }}
          </p>
  <p>
            <strong class="field-group-mid mid2">Produktposition</strong>
            {{ selectedLogbuchEntry["ProduktPosition"] }}
          </p>
          <p>
            <strong class="field-group-lge"
              >Original Produktposition</strong
            >
            {{ selectedLogbuchEntry["OriginalProduktPosition"] }}
          </p>
        </div>
        <div class="action-buttons">
           <button mat-icon-button (click)="downloadCsv()" class="download-button">
            <p class="download-btn-text">Download</p>
          </button>

          <button mat-icon-button (click)="closeLogbuch()" class="close-button">
            <p class="close-btn-text">schließen</p>
          </button>

        </div>
      </div>
          <!-- Second Format: With vorher/nachher comparison -->
          <div *ngIf="!shouldShowSimpleFormat()" class="comparison-format">
            <div class="logbuch-section">
              <p>
                <strong>Geändert am&nbsp; </strong>
                {{ selectedLogbuchEntry["Bearbeitungszeit"] }}
              </p>
              <p>
                <strong>Geändert von&nbsp; </strong>
                {{ selectedLogbuchEntry["Bearbeiter"] }} ({{
                  selectedLogbuchEntry["Bearbeiter Id"]
                }})
              </p>

              <!-- Vorher/Nachher and Freigabestatus in same line -->
              <div class="status-line">
                <span class="status-comparison">
                  <span class="vorher-nachher">
                    <span class="vorher-label">Vorher</span>
                    <!-- <span class="vorher-value">{{ getPreviousStatus() }}</span> -->

                    <span class="nachher-label">Nachher</span>
                    <!-- <span class="nachher-value">{{ selectedLogbuchEntry['Freigabestatus'] }}</span> -->
                  </span>
                  <span class="freigabestatus">
                    <strong>Freigabestatus &nbsp; </strong>
                    {{ selectedLogbuchEntry["Freigabestatus"] }}
                 <span id="vorher-value">{{ getPreviousStatus() }}</span>
                  </span>
                </span>
              </div>

              <!-- Metadaten displayed as simple text -->
              <div
                class="metadaten-simple"
                *ngIf="selectedLogbuchEntry['Metadaten']"
              >
                <p><strong>Metadaten &nbsp; </strong> {{ getFormattedMetadaten() }}</p>
              </div>
            </div>
          </div>

          <!-- Common fields for both formats
          <div class="common-fields">
            <p *ngIf="selectedLogbuchEntry['Vorgang']"><strong>Vorgang:</strong> {{ selectedLogbuchEntry['Vorgang'] }}</p>
            <p *ngIf="selectedLogbuchEntry['Anmerkung']"><strong>Anmerkung:</strong> {{ selectedLogbuchEntry['Anmerkung'] }}</p>
          </div> -->
        </div>

        <div *ngIf="!selectedLogbuchEntry" class="no-entries">
          <p>Keine Logbuch-Einträge verfügbar.</p>
        </div>
      </div>
    </div>

    <div class="header-edit-mode" *ngIf="isEditMode">
      <button mat-button class="cancel-button">
        <mat-icon>close</mat-icon> Abbrechen
      </button>
      <span class="title">Freigabe</span>
      <button mat-button class="save-button" (click)="saveChanges()">
        <mat-icon>check</mat-icon> Speichern
      </button>
    </div>
  </div>

  <div class="content">
    <div class="left-container">
      <table mat-table [dataSource]="dataSource" class="mat-elevation-z2">
    <!-- Produktposition Column -->
<ng-container matColumnDef="Produktposition">
  <th mat-header-cell *matHeaderCellDef (click)="toggleSort('Produktposition')">
    <div class="sort-header">
      Produktposition
      <mat-icon class="sort-icon">{{getSortIcon("Produktposition")}}</mat-icon>
    </div>
  </th>
 <td mat-cell *matCellDef="let element"  class="cell-main-form">
  {{ element.produktPositionDisplay || 'No' }}
</td>

</ng-container>

        <!-- Monat Column -->
        <ng-container matColumnDef="Monat">
          <th mat-header-cell *matHeaderCellDef (click)="toggleSort('Monat')">
            <div class="sort-header">
              Monat
              <mat-icon class="sort-icon">{{ getSortIcon("Monat") }}</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" class="cell-main-form">
            {{ element.Monat }}
          </td>
        </ng-container>

        <!-- Mitarbeiter Column -->
        <ng-container matColumnDef="Mitarbeiter">
          <th
            mat-header-cell
            *matHeaderCellDef
            (click)="toggleSort('Mitarbeiter')"
          >
            <div class="sort-header">
              Mitarbeiter
              <mat-icon class="sort-icon">{{
                getSortIcon("Mitarbeiter")
              }}</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" class="cell-main-form">
            {{ element.Mitarbeiter }}
          </td>
        </ng-container>

        <!-- Std Column -->
        <ng-container matColumnDef="Std">
          <th mat-header-cell *matHeaderCellDef (click)="toggleSort('Std')">
            <div class="sort-header">
              Std.
              <mat-icon class="sort-icon">{{ getSortIcon("Std") }}</mat-icon>
            </div>
          </th>
          <td mat-cell *matCellDef="let element" class="cell-main-form">
            {{ element.Std }}
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td
            mat-cell
            *matCellDef="let element"
            class="actions-cell cell-main-form"
          >
            <ng-container [ngSwitch]="element.freigabeStatus">
              <button mat-icon-button *ngSwitchCase="'ABGELEHNT'">
                <mat-icon>close</mat-icon>
              </button>
              <button mat-icon-button *ngSwitchCase="'PRUEFEN_DV'">
                <mat-icon class="bolded-icon">manage_search</mat-icon>
              </button>
              <button mat-icon-button *ngSwitchCase="'FREIGEGEBEN'">
                <mat-icon>check</mat-icon>
              </button>
            </ng-container>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; let i = index; columns: displayedColumns"
          [ngClass]="getOddEvenRowClass(i)"
          [ngStyle]="getRowStyle(row)"
          (click)="selectEntry(row)"
        ></tr>
      </table>
    </div>

    <div class="right-container">
      <div *ngIf="selectedEntry" class="detail-view">
        <ng-container *ngIf="!isEditMode">
          <!-- Detailed data table section (original view) -->
          <div class="detail-section" *ngIf="detailedData.length > 0">
            <div class="contain-header">
              <h4 class="table-header">Tätigkeitsbuchungen</h4>
            </div>
            <table mat-table [dataSource]="detailedData" class="detail-table">
              <!-- Datum Column -->
              <ng-container matColumnDef="Datum">
                <th mat-header-cell *matHeaderCellDef (click)="toggleDetailSort('Datum')">
                  <div class="sort-header">
                    Datum
                    <mat-icon class="sort-icon">{{ getDetailSortIcon("Datum") }}</mat-icon>
                  </div>
                </th>
                <td mat-cell *matCellDef="let element">{{ element.Datum }}</td>
              </ng-container>

              <!-- Buchungspunkt Column -->
              <ng-container matColumnDef="Buchungspunkt">
                <th mat-header-cell *matHeaderCellDef (click)="toggleDetailSort('Buchungspunkt')">
                  <div class="sort-header">
                    Buchungspunkt
                    <mat-icon class="sort-icon">{{ getDetailSortIcon("Buchungspunkt") }}</mat-icon>
                  </div>
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.Buchungspunkt }}
                </td>
              </ng-container>

              <!-- Tatigkeit Column -->
              <ng-container matColumnDef="Tatigkeit">
                <th mat-header-cell *matHeaderCellDef (click)="toggleDetailSort('Tatigkeit')">
                  <div class="sort-header">
                    Tätigkeit
                    <mat-icon class="sort-icon">{{ getDetailSortIcon("Tatigkeit") }}</mat-icon>
                  </div>
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.Tatigkeit }}
                </td>
              </ng-container>

              <!-- Stunden Column -->
              <ng-container matColumnDef="Stunden">
                <th mat-header-cell *matHeaderCellDef (click)="toggleDetailSort('Stunden')">
                  <div class="sort-header">
                    Std.
                    <mat-icon class="sort-icon">{{ getDetailSortIcon("Stunden") }}</mat-icon>
                  </div>
                </th>
                <td mat-cell *matCellDef="let element">
                  {{ element.Stunden }}
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="detailDisplayedColumns"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: detailDisplayedColumns"
              ></tr>
            </table>
          </div>

          <!-- Loading/No data messages for original view -->
          <div *ngIf="selectedEntry && isLoading" class="placeholder-content">
            <p>Lade Detaildaten...</p>
          </div>
          <div
            *ngIf="selectedEntry && detailedData.length === 0 && !isLoading"
            class="placeholder-content"
          >
            <p>Keine Detaildaten gefunden für diesen Eintrag.</p>
          </div>
        </ng-container>
      </div>
      <div *ngIf="!selectedEntry" class="placeholder-content">
        <p>Bitte wählen Sie einen Eintrag aus der linken Tabelle.</p>
      </div>
    </div>
  </div>
</div>
