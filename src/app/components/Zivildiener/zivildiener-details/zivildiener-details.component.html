<div class="container">
  <div class="content">
    <!-- Left Panel - Tree -->
    <div class="left-panel">
      <div class="header">
        <div class="header-content">
          <button mat-icon-button class="icon-button" (click)="goBackToList()">
            <mat-icon>arrow_back</mat-icon>
          </button>
          <h2 class="header-title">Arbeitszeiten</h2>
          <button
            mat-icon-button
            class="icon-button"
            (click)="addNewStempelzeit()"
          >
            <mat-icon>alarm</mat-icon>
          </button>
        </div>
      </div>

      <!-- NESTED TREE STRUCTURE -->
      <mat-tree
        [dataSource]="dataSource"
        [treeControl]="treeControl"
        class="tree"
      >
        <mat-nested-tree-node *matTreeNodeDef="let node">
          <div [ngSwitch]="node.level" (click)="onNodeClick(node)">
            <!-- MONTH LEVEL (0) -->
            <div
              *ngSwitchCase="0"
              class="node-content month-node"
              [class.selected-month]="selectedMonth === node.name"
            >
              <div class="tree-node-header">
                <button
                  mat-icon-button
                  matTreeNodeToggle
                  [attr.aria-label]="'toggle ' + node.name"
                  (click)="$event.stopPropagation()"
                >
                  <mat-icon class="mat-icon-rtl-mirror">
                    {{
                      treeControl.isExpanded(node)
                        ? "expand_more"
                        : "chevron_right"
                    }}
                  </mat-icon>
                </button>

                <div class="month-header">
                  <mat-icon class="month-icon">calendar_month</mat-icon>
                  <span class="month-name">{{ node.name }}</span>
                </div>

                <div class="month-details">
                  <div class="zivild-first-line">
                  <div class="detail-row">
                    <mat-icon class="detail-icon2">sync</mat-icon>
                    <span
                      class="detail-label"
                      [style.color]="getArbeitszeitLabelColor(node.arbeitszeit)"
                      [style.font-weight]="getValueFontWeight(node.arbeitszeit)"
                    >
                      Arbeitszeit:
                    </span>
                    <span
                      class="detail-value arbeitszeit-value"
                      [style.color]="getArbeitszeitValueColor(node.arbeitszeit)"
                      [style.font-weight]="getValueFontWeight(node.arbeitszeit)"
                    >
                      {{ node.arbeitszeit || "00:00" }}
                    </span>
                  </div>

                  <div class="detail-row">
                    <span class="detail-label">Soll-Arbeitszeit:</span>
                    <span class="detail-value">{{
                      node.sollArbeitszeit || "00:00"
                    }}</span>
                  </div>

                  <div class="detail-row">
                    <span
                      class="detail-label"
                      [style.color]="getSaldoColorValue(node.saldo)"
                      [style.font-weight]="getValueFontWeight(node.saldo)"
                    >
                      Saldo:
                    </span>
                    <span
                      class="detail-value saldo-value"
                      [style.color]="getSaldoColorValue(node.saldo)"
                      [style.font-weight]="getValueFontWeight(node.saldo)"
                    >
                      {{ node.saldo || "00:00" }}
                    </span>
                  </div>
                  </div>
                  <div class="zivild-second-line">
                    <div class="detail-row">
                      <span
                        class="detail-label"
                        [style.color]="getUrlaubstageColor(node.urlaubstage)"
                        [style.font-weight]="
                          getValueFontWeight(node.urlaubstage)
                        "
                      >
                        Urlaubstage:
                      </span>
                      <span
                        class="detail-value"
                        [style.color]="getUrlaubstageColor(node.urlaubstage)"
                        [style.font-weight]="
                          getValueFontWeight(node.urlaubstage)
                        "
                      >
                        {{ node.urlaubstage || "0" }}
                      </span>
                    </div>

                    <div class="detail-row" *ngIf="node.urlaub">
                      <span
                        class="detail-label"
                        [style.color]="getUrlaubColor(node.urlaub)"
                        [style.font-weight]="getValueFontWeight(node.urlaub)"
                      >
                        Urlaub:
                      </span>
                      <span
                        class="detail-value"
                        [style.color]="getUrlaubColor(node.urlaub)"
                        [style.font-weight]="getValueFontWeight(node.urlaub)"
                      >
                        {{ node.urlaub }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- DAY LEVEL (1) -->
            <div
              *ngSwitchCase="1"
              class="node-content day-node"
              [class.selected-day]="selectedDayNode === node"
            >
              <div class="tree-node-header">
                <button
                  mat-icon-button
                  [attr.aria-label]="'toggle ' + node.name"
                  (click)="onDayToggle(node, $event)"
                  class="day-button-toggle"
                >
                  <mat-icon class="icon-level1">
                    {{
                      treeControl.isExpanded(node)
                        ? "expand_more"
                        : "chevron_right"
                    }}
                  </mat-icon>
                </button>

                <div class="detail-line">
                  <mat-icon class="event-icon">event</mat-icon>
                  <span class="day-of-week"
                    >{{ getDayOfWeekFromNode(node) }}.</span
                  >
                  <span class="date-display">{{
                    getDateDisplayFromNode(node)
                  }}</span>
                  <span
                    class="type-time-display arbeitszeit-value"
                    [style.color]="
                      isPositive(node.arbeitszeit)
                        ? 'green'
                        : isNegative(node.arbeitszeit)
                        ? 'red'
                        : 'purple'
                    "
                  >
                    {{ getTypeDisplay(node.zeitTyp || "") }}:
                    {{ node.arbeitszeit }}
                  </span>
                  <button
                    class="icon-button"
                    id="alarm-icon"
                    (click)="
                      addNewStempelzeitForDay(node); $event.stopPropagation()
                    "
                  >
                    <mat-icon>alarm</mat-icon>
                  </button>
                </div>
              </div>
            </div>
            <!-- STEMPELZEIT LEVEL (2) -->
            <div
              *ngSwitchCase="2"
              class="stempelzeit-line"
              [class.selected]="selectedStempelzeitNode === node"
            >
              <span class="stempelzeit-range">{{ node.name }}</span>
              <span class="stempelzeit-type">{{
                getTypeDisplay(node.zeitTyp || "")
              }}</span>

              <span
                *ngIf="node.stempelzeit?.anmerkung"
                class="stempelzeit-anmerkung"
              >
                [{{ node.stempelzeit.anmerkung }}]
              </span>
            </div>
          </div>

          <!-- CHILDREN CONTAINER -->
          <div
            *ngIf="node.level !== 2 && treeControl.isExpanded(node)"
            class="tree-node-children"
          >
            <ng-container matTreeNodeOutlet></ng-container>
          </div>
        </mat-nested-tree-node>
      </mat-tree>
    </div>

    <!-- Right Panel - Table or Form -->
    <div class="right-panel">
      <!-- Month Table View -->
      <div
        *ngIf="selectedMonth && !selectedDayNode && !selectedStempelzeitNode"
      >
        <div class="header">
          <div class="header-right">
            <button mat-icon-button class="icon-button">
              <mat-icon>menu</mat-icon>
            </button>
            <h2 class="header-title month-name">{{ selectedMonth }}</h2>
          </div>
        </div>
        <div class="table-container">
          <table mat-table [dataSource]="timeEntries" class="time-table">
            <ng-container matColumnDef="bezeichnung">
              <th mat-header-cell *matHeaderCellDef class="bezeichnung-header">
                Bezeichnung
              </th>
              <td
                mat-cell
                *matCellDef="let entry"
                [class]="getRowBackgroundClass(entry.zeitTyp)"
              >
                {{ getTypeDisplay(entry.zeitTyp) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="space">
              <th mat-header-cell *matHeaderCellDef></th>
              <td
                mat-cell
                *matCellDef="let entry"
                [class]="getRowBackgroundClass(entry.zeitTyp)"
              >
                {{ getWeek(entry) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="datum">
              <th mat-header-cell *matHeaderCellDef>Datum</th>
              <td
                mat-cell
                *matCellDef="let entry"
                [class]="getRowBackgroundClass(entry.zeitTyp)"
              >

                {{ getFormattedDate(entry.login) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="uhrzeit">
              <th mat-header-cell *matHeaderCellDef>Uhrzeit</th>
              <td
                mat-cell
                *matCellDef="let entry"
                [class]="getRowBackgroundClass(entry.zeitTyp)"
              >
                {{ getFormattedTime(entry.login) }} -
                {{ getFormattedTime(entry.logoff) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="stunden">
              <th mat-header-cell *matHeaderCellDef>Stunden</th>
              <td
                mat-cell
                *matCellDef="let entry"
                [class]="getRowBackgroundClass(entry.zeitTyp)"
              >
                {{ calculateHours(entry.login, entry.logoff) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="saldo">
              <th mat-header-cell *matHeaderCellDef>Saldo</th>
              <td
                mat-cell
                *matCellDef="let entry"
                [class]="getRowBackgroundClass(entry.zeitTyp)"
              >
                <span
                  [style.color]="getSaldoColorValue(calculateSaldo(entry))"
                  [style.font-weight]="
                    getSaldoFontWeight(calculateSaldo(entry))
                  "
                >
                  {{ calculateSaldo(entry) }}
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="anmerkung">
              <th mat-header-cell *matHeaderCellDef>Anmerkung</th>
              <td
                mat-cell
                *matCellDef="let entry"
                [class]="getRowBackgroundClass(entry.zeitTyp)"
              >
                {{ entry.anmerkung || "-" }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
        </div>
      </div>

      <!-- Day Form -->
      <div *ngIf="selectedDayNode && !selectedStempelzeitNode" class="day-form">
        <div class="header">
          <div class="header-right-child">
            <h2 class="header-title" *ngIf="selectedDayNode">
              {{ getFullDayOfWeekFromNode(selectedDayNode) }}
              {{ getDateDisplayFromNode(selectedDayNode) }}
            </h2>
          </div>
        </div>

        <div class="form-group">
          <div class="group-one">
            <label>Arbeitszeit [std:min]:</label>
            <input
              type="text"
              class="form-control"
              [value]="selectedDayNode.arbeitszeit || '00:00'"
              readonly
            />
          </div>

          <div class="group-two">
            <label>Stempelzeiten:</label>
            <textarea
              name="stempelzeiten"
              id="stempelzeiten"
              class="form-control"
              rows="3"
              readonly
              >{{ getDayStempelzeitenText(selectedDayNode) }}</textarea
            >
          </div>
        </div>
      </div>

      <!-- Level 2 Stempelzeit Form Panel -->
      <div *ngIf="selectedStempelzeitNode" class="stempelzeit-form-panel">
        <div class="form-header">
          <!-- DELETE / CANCEL -->
          <button
            mat-button
            class="header-btn"
            [disabled]="!selectedStempelzeitNode"
            (click)="
              isCreatingNew
                ? cancelNewEntry()
                : isEditing
                ? cancelFormChanges()
                : deleteStempelzeit()
            "
          >
            <mat-icon class="{{ isEditing ? '' : 'delete-icon' }}">
              {{ isCreatingNew || isEditing ? "close" : "delete" }}
            </mat-icon>
            <span>
              {{ isCreatingNew || isEditing ? "Abbrechen" : "LÃ¶schen" }}
            </span>
          </button>

          <h2 class="right-header">
            {{ isCreatingNew ? "Neue Stempelzeit" : "Stempelzeit" }}
          </h2>

          <!-- EDIT / SAVE -->
          <button
            mat-button
            (click)="
              isCreatingNew
                ? saveStempelzeit()
                : isEditing
                ? saveStempelzeit()
                : (isEditing = true)
            "
            class="header-btn"
            [class.primary]="isEditing || isCreatingNew"
            [disabled]="!selectedStempelzeitNode && !isCreatingNew"
          >
            <mat-icon>
              {{ isCreatingNew ? "check" : isEditing ? "check" : "edit" }}
            </mat-icon>
            <span>
              {{
                isCreatingNew
                  ? "Speichern"
                  : isEditing
                  ? "Speichern"
                  : "Bearbeiten"
              }}
            </span>
          </button>
        </div>

        <!-- Form Content -->
        <form [formGroup]="stempelzeitForm" class="stempelzeit-form">
          <!-- Datum Field -->
          <div class="form-field-group">
            <label class="field-label">Datum</label>
            <mat-form-field appearance="outline" class="field-input">
              <input
                matInput
                formControlName="datum"
                [readonly]="!isEditing && !isCreatingNew"
                class="datum"

              />
            </mat-form-field>
          </div>

          <!-- Zeittyp Dropdown -->
          <div class="form-field-group">
            <label class="field-label">Zeittyp</label>
            <mat-form-field
              appearance="outline"
              class="field-input zeittyp-field"
            >
              <mat-select
                formControlName="zeittyp"
                [disabled]="!isEditing && !isCreatingNew"
                (selectionChange)="onZeittypChange($event)"
                (closed)="onDropdownClosed()"
                panelClass="zeittyp-panel"
              >
                <mat-option
                  *ngFor="let zeittyp of ZeittypDrop"
                  [value]="zeittyp"
                >
                  {{ getTypeDisplay(zeittyp) }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Time Input Section -->
          <div class="time-section">
            <!-- Anmeldezeit -->
            <div class="time-group">
              <label class="time-label">Anmeldezeit[Stunde]</label>
              <div class="time-inputs-horizontal">
                <!-- Stunde -->
                <div class="time-column">
                  <div class="time-box">
                    <button
                      type="button"
                      class="time-btn minus dash"
                      (click)="decreaseHour('anmeldezeit')"
                      [disabled]="
                        (!isEditing && !isCreatingNew) ||
                        getHour('anmeldezeit') <= 0
                      "
                    >
                      <mat-icon>remove</mat-icon>
                    </button>
                    <div class="time-value">
                      <input
                        type="number"
                        formControlName="anmeldezeitStunde"
                        min="0"
                        max="24"
                        [readonly]="!isEditing && !isCreatingNew"
                        class="time-input"
                        (change)="validateTime('anmeldezeit')"
                      />
                    </div>
                    <button
                      type="button"
                      class="time-btn plus dash"
                      (click)="increaseHour('anmeldezeit')"
                      [disabled]="
                        (!isEditing && !isCreatingNew) ||
                        getHour('anmeldezeit') >= 24
                      "
                    >
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                </div>

                <!-- Minuten -->
                <div class="time-column">
                  <div class="mint">
                    <span class="time-unit">[Minuten]</span>
                  </div>
                  <div class="time-box">
                    <button
                      type="button"
                      class="time-btn minus dash"
                      (click)="decreaseMinute('anmeldezeit')"
                      [disabled]="
                        (!isEditing && !isCreatingNew) ||
                        getMinute('anmeldezeit') <= 0 ||
                        getHour('anmeldezeit') === 24
                      "
                    >
                      <mat-icon>remove</mat-icon>
                    </button>
                    <div class="time-value">
                      <input
                        type="number"
                        formControlName="anmeldezeitMinuten"
                        min="0"
                        max="59"
                        [readonly]="!isEditing && !isCreatingNew"
                        class="time-input"
                        (change)="validateTime('anmeldezeit')"
                      />
                    </div>
                    <button
                      type="button"
                      class="time-btn plus dash"
                      (click)="increaseMinute('anmeldezeit')"
                      [disabled]="
                        (!isEditing && !isCreatingNew) ||
                        getMinute('anmeldezeit') >= 59 ||
                        getHour('anmeldezeit') === 24
                      "
                    >
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Abmeldezeit -->
            <div class="time-group">
              <label class="time-label">Abmeldezeit[Stunde]</label>
              <div class="time-inputs-horizontal">
                <!-- Stunde -->
                <div class="time-column">
                  <div class="time-box">
                    <button
                      type="button"
                      class="time-btn minus dash"
                      (click)="decreaseHour('abmeldezeit')"
                      [disabled]="
                        (!isEditing && !isCreatingNew) ||
                        getHour('abmeldezeit') <= 0
                      "
                    >
                      <mat-icon>remove</mat-icon>
                    </button>
                    <div class="time-value">
                      <input
                        type="number"
                        formControlName="abmeldezeitStunde"
                        min="0"
                        max="24"
                        [readonly]="!isEditing && !isCreatingNew"
                        class="time-input"
                        (change)="validateTime('abmeldezeit')"
                      />
                    </div>
                    <button
                      type="button"
                      class="time-btn plus dash"
                      (click)="increaseHour('abmeldezeit')"
                      [disabled]="
                        (!isEditing && !isCreatingNew) ||
                        getHour('abmeldezeit') >= 24
                      "
                    >
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                </div>

                <!-- Minuten -->
                <div class="time-column">
                  <div class="mint">
                    <span class="time-unit">[Minuten]</span>
                  </div>
                  <div class="time-box">
                    <button
                      type="button"
                      class="time-btn minus dash"
                      (click)="decreaseMinute('abmeldezeit')"
                      [disabled]="
                        (!isEditing && !isCreatingNew) ||
                        getMinute('abmeldezeit') <= 0 ||
                        getHour('abmeldezeit') === 24
                      "
                    >
                      <mat-icon>remove</mat-icon>
                    </button>
                    <div class="time-value">
                      <input
                        type="number"
                        formControlName="abmeldezeitMinuten"
                        min="0"
                        max="59"
                        [readonly]="!isEditing && !isCreatingNew"
                        class="time-input"
                        (change)="validateTime('abmeldezeit')"
                      />
                    </div>
                    <button
                      type="button"
                      class="time-btn plus dash"
                      (click)="increaseMinute('abmeldezeit')"
                      [disabled]="
                        (!isEditing && !isCreatingNew) ||
                        getMinute('abmeldezeit') >= 59 ||
                        getHour('abmeldezeit') === 24
                      "
                    >
                      <mat-icon>add</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Anmerkung Field -->
          <div class="form-field-group">
            <label class="field-label">Anmerkung</label>
            <mat-form-field appearance="outline" class="field-input full-width">
              <textarea
                matInput
                formControlName="anmerkung"
                rows="3"
                [attr.readonly]="!isEditing && !isCreatingNew ? true : null"
                placeholder="Anmerkung eingeben..."
              ></textarea>
            </mat-form-field>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
